function _getCkeInstance(a){var b=jQuery("#ckeditor_instance_"+a);return console.debug("_getCkeInstance",b.data("cke_instance")),b.data("cke_instance")}function editorGetContentTextarea_xe(a){return console.debug("editorGetContentTextarea_xe",_getCkeInstance(a).getText()),_getCkeInstance(a).getText()}function editorGetSelectedHtml(a){return console.debug("editorGetSelectedHtml",_getCkeInstance(a).getSelection().getSelectedText()),_getCkeInstance(a).getSelection().getSelectedText()}function editorGetContent(a){return console.debug("editorGetContent",_getCkeInstance(a).getData()),_getCkeInstance(a).getData()}function insertElement(a,b){return console.debug("insertElement",b),_getCkeInstance(a).insertHtml(b)}function editorReplaceHTML(a,b){console.debug("editorReplaceHTML",a,b),b=editorReplacePath(b),_getCkeInstance(parseInt(a.id.replace(/^.*_/,""),10)).insertHtml(b,"unfiltered_html")}function editorGetIFrame(a){return console.debug("editorGetIFrame",a),jQuery("#ckeditor_instance_"+a).get(0)}function editorReplacePath(a){return a=a.replace(/\<([^\>\<]*)(src=|href=|url\()("|\')*([^"\'\)]+)("|\'|\))*(\s|>)*/gi,function(a,b,c,d,e,f,g){"url("==c?(d="",f=")"):(void 0===d&&(d='"'),void 0===f&&(f='"'),void 0===g&&(g=""));var h=jQuery.trim(e).replace(/^\.\//,"");return/^(http\:|https\:|ftp\:|telnet\:|mms\:|mailto\:|\/|\.\.|\#)/i.test(h)?a:"<"+b+c+d+request_uri+h+f+g})}function ckInsertUploadedFile(a){var b="",c=uploaderSettings[a],d=c.fileListAreaID,e=get_by_id(d);if(e&&"preview"!=editorMode[a]){for(var f=0;f<e.options.length;f++)if(e.options[f].selected){var g=e.options[f].value;if(g){var h=uploadedFiles[g];if("Y"==h.direct_download)if(/\.(jpg|jpeg|png|gif)$/i.test(h.download_url)){if(loaded_images[g])var i=loaded_images[g];else{var i=new Image;i.src=h.download_url}b+='<img src="'+h.download_url+'" alt="'+h.source_filename+'"',1==i.complete&&(b+=' width="'+i.width+'" height="'+i.height+'"'),b+=" />\r\n"}else b='<img src="common/img/blank.gif" editor_component="multimedia_link" multimedia_src="'+h.download_url+'" width="400" height="320" style="display:block;width:400px;height:320px;border:2px dotted #4371B9;background:url(./modules/editor/components/multimedia_link/tpl/multimedia_link_component.gif) no-repeat center;" auto_start="false" alt="" />';else b='<a href="'+h.download_url+'">'+h.source_filename+"</a>\n"}}cked_instance="ckeditor_instance_"+a,CKEDITOR.instances[cked_instance].insertHtml(b)}}function editorStartTextarea(a,b,c){var d=xGetElementById("editor_"+a),e=xGetElementById("htm_"+a).value;d.form.setAttribute("editor_sequence",a),d.style.width="100%",editorRelKeys[a]=new Array,editorRelKeys[a].primary=d.form[c],editorRelKeys[a].content=d.form[b],editorRelKeys[a].func=editorGetContentTextarea;var f=d.form[b].value;e&&(f=f.replace(/<br([^>]*)>/gi,"\n"),"br"!=e&&(f=f.replace(/&lt;/g,"<"),f=f.replace(/&gt;/g,">"),f=f.replace(/&quot;/g,'"'),f=f.replace(/&amp;/g,"&"))),d.value=f}function editorGetContentTextarea(a){var b=xGetElementById("editor_"+a),c=xGetElementById("htm_"+a).value,d=b.value.trim();return c&&("br"!=c&&(d=d.replace(/&/g,"&amp;"),d=d.replace(/</g,"&lt;"),d=d.replace(/>/g,"&gt;"),d=d.replace(/\"/g,"&quot;")),d=d.replace(/(\r\n|\n)/g,"<br />")),d}!function(a){"use strict";function b(b){return a.grep(b,function(c,d){return c.length&&a.inArray(c,b)===d})}function c(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,c||a.apply(e,f)},h=c&&!d;clearTimeout(d),d=setTimeout(g,b),h&&a.apply(e,f)}}a.widget("xe.CKEditor",{options:{test:0},default_ckeconfig:{bodyClass:"xe_content editable",toolbarCanCollapse:!0,toolbarGroups:[{name:"clipboard",groups:["undo","clipboard"]},{name:"editing",groups:["find","selection"]},{name:"links"},{name:"insert"},{name:"tools"},{name:"document",groups:["mode"]},"/",{name:"basicstyles",groups:["basicstyles","cleanup"]},{name:"paragraph",groups:["list","indent","blocks","align","bidi"]},"/",{name:"styles"},{name:"colors"},{name:"xecomponent"},{name:"others"}],allowedContent:!0,removePlugins:"stylescombo,language,bidi,flash,pagebreak",removeButtons:"Save,Preview,Print,Cut,Copy,Paste",extraPlugins:"autosavemsg",uiColor:"#EFF0F0"},_create:function(b){var c=this,d=this.element.closest("form"),e=d.find('[name="'+this.options.contentKeyName+'"]');this.editorSequence=this.options.editorSequence||this.element.data("primary-key-name"),d.attr("editor_sequence",this.editorSequence),this.options.ckeconfig=a.extend({},this.default_ckeconfig,this.options.ckeconfig),this._mergeCkeconfig(this.options.ckeconfig),console.debug("xe.CKEditor _create()",this,this.options.ckeconfig),CKEDITOR.plugins.add("autosavemsg",{init:function(a){a._.autosaveMsg={idBase:"cke_autosave_"+CKEDITOR.tools.getNextNumber()+"_",filters:[]},a.on("uiSpace",function(b){if("bottom"===b.data.space){var c=a.ui.spaceId("autosave");b.data.html+='<span id="'+c+'" class="cke_autosave" style="float: right;"></span>',a.on("uiReady",function(){var b=a.ui.space("autosave");b&&a.focusManager.add(b,1),CKEDITOR.document.getById(c)})}})}}),this.ckeInstance=CKEDITOR.appendTo(this.element.get(0),this.options.ckeconfig,e.val()),this.ckeInstance.on("customConfigLoaded",function(){if(a.isFunction(CKEDITOR.editorConfig)){var b={};CKEDITOR.editorConfig(b),c.ckeInstance.config=c._mergeCkeconfig(b)}}),console.debug("xe.CKEditor _create()",this.options.ckeconfig,this.ckeInstance.config),a.data(this,"xe-ckeditor-instance",this.ckeInstance),jQuery("#ckeditor_instance_"+this.editorSequence).data("cke_instance",this.ckeInstance),console.debug("data xe-ckeditor-instance",a.data(this,"xe-ckeditor-instance")),this.options.autosave.enable&&(this._enableAutosave(),this._loadAutosave()),window.editorRelKeys[this.editorSequence]={},window.editorRelKeys[this.editorSequence].primary=this.element.get(0),window.editorRelKeys[this.editorSequence].content=e.get(0),window.editorRelKeys[this.editorSequence].func=function(a){return c.getContent.call(c,a)},window.editorRelKeys[this.editorSequence].pasteHTML=function(a){c.ckeInstance.insertHtml(a,"html")}},getInstance:function(){return a.data(this,"xe-ckeditor-instance")},getTitle:function(){this.element.closest("form")},getContent:function(){return console.debug("getContent",this.ckeInstance.getData()),this.ckeInstance.getData()},insertContent:function(a){this.ckeInstance.insertHtml(a)},_autosave:function(){var b=this,c=this.element.closest("form"),d={title:a("[name=title]",c).val()||null,content:this.ckeInstance.getData()||null,mid:window.current_mid||null,document_srl:a("[name=document_srl]",c).val()||null};if(d.title||d.content){if(Modernizr.sessionstorage){var e=["autosave"];if(e.push(window.current_mid||"*"),e.join("."),window.sessionStorage.getItem(e)===JSON.stringify(d))return;window.sessionStorage.setItem(e,JSON.stringify(d))}window.exec_json("editor.procEditorSaveDoc",d,function(a){console.debug("editor.procEditorSaveDoc",a,b._spaceElement);var c=b.ckeInstance.ui.spaceId("autosave"),d=CKEDITOR.document.getById(c),e=new Date,f=e.toLocaleTimeString(navigator.language,{})+" "+a.message;d.setHtml(f)})}},_enableAutosave:function(){var a=this,b=c(function(){a._autosave()},1e4);setInterval(function(){b()},15e3),this.ckeInstance.on("saveSnapshot",function(a){b()})},_mergeCkeconfig:function(c){var d=a.extend({},this.options.ckeconfig);if(c.bodyClass){var e=d.bodyClass.split(" ");e.concat(c.bodyClass.split(" ")),e=b(e),d.bodyClass=e.join(" ")}if(this.options.loadXeComponent){var f=this.options.ckeconfig.extraPlugins.split(",");f.push("xe_component"),f=b(f),d.extraPlugins=f.join(",")}if(CKEDITOR.env.iOS&&this.options.removePlugins){var g=this.options.ckeconfig.removePlugins.split(",");g.push("enterkey"),g=b(g),d.removePlugins=g.join(",")}return this.options.enableToolbar||(d.toolbar=[]),this.options.ckeconfig=d,this.options.ckeconfig},_loadAutosave:function(){var a=this,b=this.element.closest("form");if(this.options.autosave.exists)if(confirm(this.options.autosave.message)){b.find("[name=title]").val(b.find("[name=_saved_doc_title]").val()),this.ckeInstance.setData(b.find("[name=_saved_doc_content]").val());var c=new Array;c.mid=window.current_mid,c.editor_sequence=this.editorSequence,window.exec_json("editor.procEditorLoadSavedDocument",c,function(b){b.document_srl&&(window.editorRelKeys[a.editorSequence].primary.value=b.document_srl)})}else a._editorRemoveSavedDoc()},_editorRemoveSavedDoc:function(){window.exec_json("editor.procEditorRemoveSavedDoc",{mid:current_mid})}})}(jQuery);