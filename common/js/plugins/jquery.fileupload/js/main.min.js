!function(a){"use strict";function b(){d&&"function"==typeof console.debug&&(arguments[0]="[$.xe.fileUploader] "+arguments[0],console.debug.apply(this,arguments))}var c;a.widget("xe.fileUploader",a.blueimp.fileupload,{options:{loadedFileList:function(a,c){b("loadedFileList",a,c)},imageAutoAttach:!0,sequentialUploads:!0,maxChunkSize:1024e3,leftUploadLimit:0,limitFileSize:0,limitTotalFileSize:0,editorSequence:null,uploadTargetSrl:null,tmplFileItemId:"tmpl-xefu-item-file",tmplImageItemId:"tmpl-xefu-item-image",classes:{dropZone:".xefu-dropzone",dropZoneMessage:".xefu-dropzone-message",controll:".xefu-controll",fileList:".xefu-list-container",filelistOther:".xefu-list-other ul",filelistImages:".xefu-list-images ul",progressbar:".xefu-progressbar",progressbarGraph:".xefu-progressbar div",progressStatus:".xefu-progress-status",progressPercent:".xefu-progress-percent",actSelectable:".xefu-act-mode-selectable",actSelectedInsertContent:".xefu-act-link-selected",actSelectedDeleteFile:".xefu-act-delete-selected",actSelectAll:".xefu-select-all",actSelectAllImages:".xefu-select-all-images",actUnselectAll:".xefu-unselect-all",actInsertMedia:".xefu-act-insert-media",actInsertFile:".xefu-act-insert-file",actDeleteFile:".xefu-act-delete",actSetCover:".xefu-act-set-cover",statusCount:".xefu-status-count",statusAttachedSize:".xefu-status-attached-size",statusLimitSize:".xefu-status-limit-size",statusFiletypesContainer:".xefu-allowed-filetypes-container",statusFiletypesText:".xefu-allowed-filetypes"},configSelectable:{appendTo:".xefu-list-container",autoRefresh:!0,distance:0,filter:"li",tolerance:"touch",toggle:!1,debug:!0},add:function(c,d){var e=a(this),f=e.data("xe-fileUploader"),g=e.fileUploader("option");d.files[0].size;if(b("_super.options.add()",f,g,d),g.limitFileSize<=d.files[0].size||g.leftUploadLimit<=d.files[0].size)return alert(window.xe.msg_exceeds_limit_size),!1;if(/^image\/(gif|jpeg|png)$/.test(d.files[0].type)){var h=a('<li class="xefu-file xefu-file-image xefu-uploading"><div class="progress"></div></li>').attr("data-uploading",d.files[0].name);f.element.find(g.classes.filelistImages).append(h)}d.submit()},send:function(){b("_super.options.send()",arguments)},done:function(){b("_super.options.done()",arguments)},stop:function(c,d){b("_super.options.stop()",d,this),a(this).data("xe-fileUploader")._loadFiles()}},booted:!1,files:[],selectMode:!1,isTouchDevice:!1,chunkedUpload:!1,_create:function(){d=this.options.debug,this.options.sequentialUploads=!0,this.options.leftUploadLimit=this.options.limitTotalFileSize,this._super(),this.isTouchDevice=window.Modernizr.touch,this.files={},this.selected_files=[],this.chunkedUpload=this.chunkedUpload&&"function"!=typeof a.support.blobSlice&&this.options.maxChunkSize,this.options.formData={editor_sequence:null,upload_target_srl:null,mid:window.current_mid,act:"procFileUpload"},this.chunkedUpload||delete this.options.maxChunkSize,this.isTouchDevice&&this.element.addClass("xefu-select-mode"),this.options.configSelectable.toggle=this.isTouchDevice,c=a.xe.selectable(this.options.configSelectable,a(".xefu-list-container")),b("_create()",this)},toggleSelectMode:function(){b("toggleSelectMode()"),this.element.toggleClass("xefu-select-mode"),c.unselectAll()},_init:function(){b("_init()");var d=this;this._super(),this.element.find(".xefu-image-auto-attach").prop("checked",this.options.imageAutoAttach),this.element.find(".xefu-image-auto-attach").on("change",function(){var c=a(this);b("auto-attach.change",c.prop("checked")),d.options.imageAutoAttach=c.prop("checked")}),this.element.on("click",this.options.classes.actInsertMedia,function(b){b.preventDefault();var c=a(this),e=c.data("file-srl")||c.closest(".xefu-file").data("file-srl");d._insertToContent([e])}),this.element.on("click",this.options.classes.actInsertFile,function(b){b.preventDefault();var c=a(this),e=c.data("file-srl")||c.closest(".xefu-file").data("file-srl");d._insertToContent([e])}),this.element.on("click",this.options.classes.actDeleteFile,function(b){b.preventDefault(),b.stopPropagation();var c=a(this),e=c.data("file-srl")||c.closest(".xefu-file").data("file-srl");d._deleteFile([e])}),this.element.on("click",this.options.classes.actSelectable,function(a){a.preventDefault(),a.stopPropagation(),d.toggleSelectMode()}),this.element.on("click",this.options.classes.actSelectAll,function(){c.selectAll()}),this.element.on("click",this.options.classes.actUnselectAll,function(){c.unselectAll()}),this.element.on("click",this.options.classes.actSelectAllImages,function(){c.select(a(".xefu-file-image"))}),this.element.on("click",this.options.classes.actSelectedInsertContent,function(e){e.preventDefault();var f=c.getSelected(),g=[];b("actSelectedInsertContent",f),f.each(function(){console.log(a.data(this)),g.push(a(this).data("file-srl"))}),b("actSelectedInsertContent",g),d._insertToContent(g),c.unselectAll()}),this.element.on("click",this.options.classes.actSelectedDeleteFile,function(e){var f=c.getSelectedNodes(),g=[];e.preventDefault(),f.length&&(f.forEach(function(b){g.push(a(b).data("file-srl"))}),b("actSelectedDeleteFilee",g),d._deleteFile(g),c.unselectAll())}),this.element.on("click",this.options.classes.actSetCover,function(b){b.preventDefault();var c=a(this);d._setCover(c.data("file-srl")),c.closest("li").siblings("li").removeClass("xefu-is-cover-image"),c.closest("li").addClass("xefu-is-cover-image")}),this.options.url=window.request_uri.setQuery("module","file").setQuery("act","procFileUpload").setQuery("mid",window.current_mid),this.options.editorSequence=this.element.data("editorSequence"),this.options.formData.editor_sequence=this.options.editorSequence,this._loadFiles()},_renderList:function(d){var e=this,f=[],g=this.options,h=[],i=a("#"+g.tmplFileItemId).html(),j=Handlebars.compile(i),k=a("#"+g.tmplImageItemId).html(),l=Handlebars.compile(k),m=[],n=[];if(!d.files.length)return this.element.find(g.classes.fileList).hide(),void this.element.find(g.classes.controll).hide();b("_renderList",e.files,d.files),a.each(d.files,function(a,b){if(n.push(b.file_srl),!e.files[b.file_srl])if(e.files[b.file_srl]=b,/\.(jpe?g|png|gif)$/i.test(b.source_filename)){var c=e.element.find(g.classes.filelistImages).find('[data-uploading="'+b.source_filename+'"]');c.length?c.before(l(b)).remove():h.push(l(b)),m.push(b.file_srl)}else f.push(j(b))}),a.each(e.files,function(b,c){if(-1===a.inArray(c.file_srl,n)){a(e.options.classes.filelistImages).find("[data-file-srl="+c.file_srl+"]").remove()}}),this.element.find(g.classes.filelistImages).append(h.join("")),this.element.find(g.classes.filelistOther).append(f.join("")),this.element.find(g.classes.fileList).show(),this.element.find(g.classes.controll).show(),c.refresh(),this._updateStatus.call(this,d)},_updateStatus:function(a){this.element.find(this.options.classes.statusCount).text(a.files.length||0),this.element.find(this.options.classes.statusAttachedSize).text(a.attached_size),this.element.find(this.options.classes.statusLimitSize).text(a.allowed_attach_size),a.allowed_filetypes&&"*.*"!=a.allowed_filetypes&&(this.element.find(this.options.classes.statusFiletypesContainer).show(),this.element.find(this.options.classes.statusFiletypesText).show(a.allowed_filetypes))},_loadFiles:function(){var c=this,d=this.options,e={};e.mid=window.current_mid,e.editor_sequence=this.options.editorSequence,a.exec_json("file.getFileList",e,function(a){b("_loadFile",c.files,a),d.leftUploadLimit=a.left_size,d.uploadTargetSrl||(d.uploadTargetSrl=a.upload_target_srl,d.formData.upload_target_srl=d.uplwoadTargetSrl),a.files.length&&(c._trigger("loadedFileList",null,a),c._renderList.call(c,a))})},_insertToContent:function(c){b("_insertToContent",c);var d=this,e="",f=this.options.editorSequence;a.each(c,function(a,b){var c=d.files[b];c&&(/\.(jpe?g|png|gif)$/i.test(c.download_url)?0===c.download_url.indexOf("http://")||0===c.download_url.indexOf("https://")?e+='<p><img src="'+c.download_url+'" alt="'+c.source_filename+'" editor_component="image_link" data-file-srl="'+c.file_srl+'" /></p>':e+='<p><img src="'+window.request_uri+c.download_url+'" alt="'+c.source_filename+'" editor_component="image_link" data-file-srl="'+c.file_srl+'" /></p>':e+='<a href="'+window.request_uri+c.download_url+'" data-file-srl="'+c.file_srl+'">'+c.source_filename+"</a> ")}),insertElement(f,e)},_deleteFile:function(c){var d=this,e="",f=this.options.editorSequence,g=_getCkeInstance(f);b("_deleteFile()",c),(e=c.join(","))&&window.exec_json("file.procFileDelete",{file_srls:e,editor_sequence:f},function(e){b("file.procFileDelete",e),a.each(c,function(a,c){for(var d=g.document.find("img"),e=0;e<=d.count()-1;e++){var f=d.getItem(e);if(f.getAttribute("data-file-srl")==c){var h=f.getParent();b("_deleteFile. find element",h,h.getHtml(),h.getChildCount(),h.getChildren()),1===h.getChildCount()?h.remove():f.remove()}}}),d._loadFiles()})},_setCover:function(a){var c={};c.file_srl=a,c.editor_sequence=this.options.editorSequence,window.exec_json("file.procFileSetCoverImage",c,function(a){b("_setCover(). file.procFileSetCoverImage",c,a)})}});var d=!1}(jQuery);